<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Braun BP Scanner — Enhanced OCR</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/5.1.1/tesseract.min.js"></script>
  <style>
    body { margin:0; font-family:system-ui; background:#f8f9fa; text-align:center; padding:20px; }
    .box { max-width:500px; margin:30px auto; background:white; padding:40px; border-radius:20px; box-shadow:0 10px 40px rgba(0,0,0,0.15); }
    h1 { color:#0d6efd; margin-bottom:10px; }
    p { color:#555; margin-bottom:30px; }
    .cam { background:#0d6efd; color:white; border:none; padding:18px 40px; font-size:18px; border-radius:16px; cursor:pointer; }
    .result { margin-top:30px; padding:25px; background:#e3f2fd; border-radius:16px; font-size:38px; font-weight:900; display:none; }
    .sys { color:#d63384; }
    .dia { color:#fd7e14; }
    .pul { color:#0d6efd; }
    .loading { color:#666; font-size:16px; margin:20px 0; display:none; }
    .progress { color:#999; font-size:14px; margin:10px 0; display:none; }
    .preview { max-width:100%; margin:20px 0; display:none; border:2px solid #ddd; border-radius:8px; }
    .debug { font-size:12px; color:#999; margin:10px 0; background:#f8f9fa; padding:10px; border-radius:8px; display:none; white-space:pre-wrap; text-align:left; }
  </style>
</head>
<body>

<div class="box">
  <h1>Braun BP Scanner</h1>
  <p>Take a photo of your Braun screen</p>
  
  <input type="file" id="photo" accept="image/*" capture="environment" style="display:none">
  <button class="cam" onclick="document.getElementById('photo').click()">Camera</button>
  
  <div id="loading" class="loading">Analyzing image with OCR...</div>
  <div id="progress" class="progress">Loading...</div>
  <div id="debug" class="debug"></div>
  
  <canvas id="preview" class="preview"></canvas>
  
  <div id="result" class="result">
    SYS <span id="sys" class="sys">—</span><br>
    DIA <span id="dia" class="dia">—</span><br>
    PUL <span id="pul" class="pul">—</span>
  </div>
</div>

<script>
let worker = null;

async function initWorker() {
  if (!worker) {
    worker = await Tesseract.createWorker('eng', 1, {
      logger: m => {
        const progressEl = document.getElementById('progress');
        if (m.status === 'recognizing text') {
          progressEl.textContent = `Processing: ${Math.round(m.progress * 100)}%`;
        }
      }
    });
    
    await worker.setParameters({
      tessedit_char_whitelist: '0123456789',
      tessedit_pageseg_mode: Tesseract.PSM.SPARSE_TEXT,
      preserve_interword_spaces: '0'
    });
  }
  return worker;
}

function cropToDisplay(canvas) {
  const ctx = canvas.getContext('2d');
  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const data = imageData.data;
  
  // Find bounds of dark LCD area
  let minX = canvas.width, maxX = 0, minY = canvas.height, maxY = 0;
  
  for (let y = 0; y < canvas.height; y++) {
    for (let x = 0; x < canvas.width; x++) {
      const i = (y * canvas.width + x) * 4;
      const brightness = (data[i] + data[i+1] + data[i+2]) / 3;
      
      if (brightness < 150) { // Dark pixel
        minX = Math.min(minX, x);
        maxX = Math.max(maxX, x);
        minY = Math.min(minY, y);
        maxY = Math.max(maxY, y);
      }
    }
  }
  
  // Add padding
  const padding = 20;
  minX = Math.max(0, minX - padding);
  minY = Math.max(0, minY - padding);
  maxX = Math.min(canvas.width, maxX + padding);
  maxY = Math.min(canvas.height, maxY + padding);
  
  const width = maxX - minX;
  const height = maxY - minY;
  
  if (width > 50 && height > 50) {
    const croppedCanvas = document.createElement('canvas');
    croppedCanvas.width = width;
    croppedCanvas.height = height;
    const croppedCtx = croppedCanvas.getContext('2d');
    croppedCtx.drawImage(canvas, minX, minY, width, height, 0, 0, width, height);
    return croppedCanvas;
  }
  
  return canvas;
}

document.getElementById('photo').addEventListener('change', async function(e) {
  const file = e.target.files[0];
  if (!file) return;

  const loadingEl = document.getElementById('loading');
  const progressEl = document.getElementById('progress');
  const resultEl = document.getElementById('result');
  const debugEl = document.getElementById('debug');
  const previewCanvas = document.getElementById('preview');
  
  loadingEl.style.display = 'block';
  progressEl.style.display = 'block';
  resultEl.style.display = 'none';
  debugEl.style.display = 'block';
  debugEl.textContent = 'Loading image...';

  try {
    // Initialize worker
    await initWorker();
    
    // Load image
    const img = new Image();
    await new Promise((resolve, reject) => {
      img.onload = resolve;
      img.onerror = reject;
      img.src = URL.createObjectURL(file);
    });

    debugEl.textContent = `Image loaded: ${img.width}x${img.height}`;

    // Create canvas
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    // Scale to reasonable size
    const targetSize = 2000;
    const scale = Math.min(targetSize / Math.max(img.width, img.height), 3);
    canvas.width = img.width * scale;
    canvas.height = img.height * scale;
    
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    
    debugEl.textContent += `\nScaled to: ${canvas.width}x${canvas.height}`;

    // Crop to display area
    const croppedCanvas = cropToDisplay(canvas);
    debugEl.textContent += `\nCropped to: ${croppedCanvas.width}x${croppedCanvas.height}`;

    // Preprocessing
    const ctx2 = croppedCanvas.getContext('2d');
    let imageData = ctx2.getImageData(0, 0, croppedCanvas.width, croppedCanvas.height);
    const data = imageData.data;
    
    // Sharpen and high contrast
    for (let i = 0; i < data.length; i += 4) {
      const gray = data[i] * 0.299 + data[i+1] * 0.587 + data[i+2] * 0.114;
      // Aggressive threshold - LCD digits are very dark
      const value = gray < 90 ? 255 : 0; // Inverted: dark becomes white
      data[i] = data[i+1] = data[i+2] = value;
    }
    
    ctx2.putImageData(imageData, 0, 0);
    
    // Show preview
    previewCanvas.width = croppedCanvas.width;
    previewCanvas.height = croppedCanvas.height;
    const previewCtx = previewCanvas.getContext('2d');
    previewCtx.drawImage(croppedCanvas, 0, 0);
    previewCanvas.style.display = 'block';

    debugEl.textContent += '\nRunning OCR...';

    // Run OCR
    const { data: { text, lines, words } } = await worker.recognize(croppedCanvas);
    
    debugEl.textContent += `\nRaw OCR: "${text}"`;
    debugEl.textContent += `\nLines: ${lines.length}`;
    
    // Extract all digit sequences
    const allNumbers = text.match(/\d+/g) || [];
    debugEl.textContent += `\nNumbers found: [${allNumbers.join(', ')}]`;
    
    // Try to parse by lines
    const lineNumbers = lines.map(line => {
      const nums = line.text.match(/\d+/g);
      return nums ? nums.join('') : '';
    }).filter(n => n.length > 0);
    
    debugEl.textContent += `\nLine-by-line: [${lineNumbers.join(', ')}]`;
    
    // Use the best set of numbers we found
    let finalNumbers = lineNumbers.length >= 3 ? lineNumbers.slice(0, 3) : allNumbers.slice(0, 3);
    
    if (finalNumbers.length >= 3) {
      document.getElementById('sys').textContent = finalNumbers[0];
      document.getElementById('dia').textContent = finalNumbers[1];
      document.getElementById('pul').textContent = finalNumbers[2];
    } else {
      document.getElementById('sys').textContent = finalNumbers[0] || '---';
      document.getElementById('dia').textContent = finalNumbers[1] || '---';
      document.getElementById('pul').textContent = finalNumbers[2] || '---';
      debugEl.textContent += '\n⚠️ Less than 3 numbers detected. Try better lighting or closer photo.';
    }

    loadingEl.style.display = 'none';
    progressEl.style.display = 'none';
    resultEl.style.display = 'block';

  } catch (error) {
    console.error('OCR Error:', error);
    loadingEl.textContent = 'Error reading image. Please try again.';
    progressEl.style.display = 'none';
    debugEl.textContent += `\n❌ Error: ${error.message}`;
  }
});
</script>

</body>
</html>
