<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Braun BP Scanner ‚Äî AI Vision</title>
  <style>
    body { margin:0; font-family:system-ui; background:#f8f9fa; text-align:center; padding:20px; }
    .box { max-width:500px; margin:30px auto; background:white; padding:40px; border-radius:20px; box-shadow:0 10px 40px rgba(0,0,0,0.15); }
    h1 { color:#0d6efd; margin-bottom:10px; }
    p { color:#555; margin-bottom:30px; }
    .cam { background:#0d6efd; color:white; border:none; padding:18px 40px; font-size:18px; border-radius:16px; cursor:pointer; margin:5px; }
    .result { margin-top:30px; padding:25px; background:#e3f2fd; border-radius:16px; font-size:38px; font-weight:900; display:none; }
    .sys { color:#d63384; }
    .dia { color:#fd7e14; }
    .pul { color:#0d6efd; }
    .loading { color:#666; font-size:16px; margin:20px 0; display:none; }
    .preview { max-width:100%; margin:20px 0; display:none; border:2px solid #ddd; border-radius:8px; }
    .manual { margin:20px 0; display:none; }
    .manual input { width:80px; padding:12px; font-size:24px; text-align:center; border:2px solid #ddd; border-radius:8px; margin:5px; }
    .manual button { background:#28a745; color:white; border:none; padding:12px 30px; font-size:16px; border-radius:8px; cursor:pointer; margin-top:10px; }
  </style>
</head>
<body>

<div class="box">
  <h1>Braun BP Scanner</h1>
  <p>Take a photo of your Braun screen</p>
  
  <input type="file" id="photo" accept="image/*" capture="environment" style="display:none">
  <button class="cam" onclick="document.getElementById('photo').click()">üì∑ Take Photo</button>
  <button class="cam" style="background:#28a745" onclick="showManual()">‚å®Ô∏è Enter Manually</button>
  
  <div id="loading" class="loading">Analyzing with AI Vision...</div>
  
  <img id="preview" class="preview">
  
  <div id="manual" class="manual">
    <p style="color:#666; font-size:14px;">Enter the numbers you see:</p>
    <div>
      <input type="number" id="manualSys" placeholder="SYS" min="0" max="300">
      <input type="number" id="manualDia" placeholder="DIA" min="0" max="200">
      <input type="number" id="manualPul" placeholder="PUL" min="0" max="200">
    </div>
    <button onclick="submitManual()">Submit</button>
  </div>
  
  <div id="result" class="result">
    SYS <span id="sys" class="sys">‚Äî</span><br>
    DIA <span id="dia" class="dia">‚Äî</span><br>
    PUL <span id="pul" class="pul">‚Äî</span>
  </div>
</div>

<script>
function showManual() {
  document.getElementById('manual').style.display = 'block';
  document.getElementById('manualSys').focus();
}

function submitManual() {
  const sys = document.getElementById('manualSys').value;
  const dia = document.getElementById('manualDia').value;
  const pul = document.getElementById('manualPul').value;
  
  if (sys && dia && pul) {
    document.getElementById('sys').textContent = sys;
    document.getElementById('dia').textContent = dia;
    document.getElementById('pul').textContent = pul;
    document.getElementById('result').style.display = 'block';
    document.getElementById('manual').style.display = 'none';
  } else {
    alert('Please enter all three values');
  }
}

async function analyzeWithAI(base64Image) {
  const response = await fetch("https://api.anthropic.com/v1/messages", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      model: "claude-sonnet-4-20250514",
      max_tokens: 1000,
      messages: [
        {
          role: "user",
          content: [
            {
              type: "image",
              source: {
                type: "base64",
                media_type: "image/jpeg",
                data: base64Image
              }
            },
            {
              type: "text",
              text: "This is a Braun blood pressure monitor display showing three numbers vertically: SYS (systolic), DIA (diastolic), and PUL (pulse). Please read the three numbers from the LCD display and respond ONLY with the three numbers separated by commas, like this: 122,79,74\n\nIMPORTANT: Respond with ONLY the three numbers and commas, nothing else."
            }
          ]
        }
      ]
    })
  });

  const data = await response.json();
  return data.content[0].text.trim();
}

document.getElementById('photo').addEventListener('change', async function(e) {
  const file = e.target.files[0];
  if (!file) return;

  const loadingEl = document.getElementById('loading');
  const resultEl = document.getElementById('result');
  const previewEl = document.getElementById('preview');
  
  loadingEl.style.display = 'block';
  resultEl.style.display = 'none';
  
  try {
    // Show preview
    previewEl.src = URL.createObjectURL(file);
    previewEl.style.display = 'block';
    
    // Convert to base64
    const base64 = await new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => {
        const base64String = reader.result.split(',')[1];
        resolve(base64String);
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });

    // Analyze with Claude AI
    const result = await analyzeWithAI(base64);
    
    // Parse result
    const numbers = result.match(/\d+/g);
    
    if (numbers && numbers.length >= 3) {
      document.getElementById('sys').textContent = numbers[0];
      document.getElementById('dia').textContent = numbers[1];
      document.getElementById('pul').textContent = numbers[2];
      resultEl.style.display = 'block';
    } else {
      throw new Error('Could not parse numbers from AI response: ' + result);
    }

    loadingEl.style.display = 'none';

  } catch (error) {
    console.error('Error:', error);
    loadingEl.style.display = 'none';
    alert('AI analysis failed. Please use manual entry instead.');
    showManual();
  }
});
</script>

</body>
</html>
