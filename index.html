<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Braun BP Scanner — Multi-Method OCR</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/5.1.1/tesseract.min.js"></script>
  <style>
    body { margin:0; font-family:system-ui; background:#f8f9fa; text-align:center; padding:20px; }
    .box { max-width:500px; margin:30px auto; background:white; padding:40px; border-radius:20px; box-shadow:0 10px 40px rgba(0,0,0,0.15); }
    h1 { color:#0d6efd; margin-bottom:10px; }
    p { color:#555; margin-bottom:30px; }
    .cam { background:#0d6efd; color:white; border:none; padding:18px 40px; font-size:18px; border-radius:16px; cursor:pointer; }
    .result { margin-top:30px; padding:25px; background:#e3f2fd; border-radius:16px; font-size:38px; font-weight:900; display:none; }
    .sys { color:#d63384; }
    .dia { color:#fd7e14; }
    .pul { color:#0d6efd; }
    .loading { color:#666; font-size:16px; margin:20px 0; display:none; }
    .progress { color:#999; font-size:14px; margin:10px 0; display:none; }
    .previews { display:none; margin:20px 0; }
    .preview-img { max-width:100%; margin:10px 0; border:2px solid #ddd; border-radius:8px; }
    .debug { font-size:12px; color:#999; margin:10px 0; background:#f8f9fa; padding:10px; border-radius:8px; display:none; white-space:pre-wrap; text-align:left; max-height:200px; overflow-y:auto; }
  </style>
</head>
<body>

<div class="box">
  <h1>Braun BP Scanner</h1>
  <p>Take a photo of your Braun screen</p>
  
  <input type="file" id="photo" accept="image/*" capture="environment" style="display:none">
  <button class="cam" onclick="document.getElementById('photo').click()">Camera</button>
  
  <div id="loading" class="loading">Analyzing image with OCR...</div>
  <div id="progress" class="progress">Loading...</div>
  <div id="debug" class="debug"></div>
  
  <div id="previews" class="previews">
    <canvas id="preview1" class="preview-img"></canvas>
    <canvas id="preview2" class="preview-img"></canvas>
    <canvas id="preview3" class="preview-img"></canvas>
  </div>
  
  <div id="result" class="result">
    SYS <span id="sys" class="sys">—</span><br>
    DIA <span id="dia" class="dia">—</span><br>
    PUL <span id="pul" class="pul">—</span>
  </div>
</div>

<script>
function preprocessImage(img, method) {
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  
  // Scale up for better OCR
  const scale = Math.max(2, 1500 / Math.max(img.width, img.height));
  canvas.width = img.width * scale;
  canvas.height = img.height * scale;
  
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
  
  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const data = imageData.data;
  
  if (method === 'invert-dark') {
    // Method 1: Invert dark pixels (for dark LCD)
    for (let i = 0; i < data.length; i += 4) {
      const gray = data[i] * 0.299 + data[i+1] * 0.587 + data[i+2] * 0.114;
      const value = gray < 80 ? 255 : 0;
      data[i] = data[i+1] = data[i+2] = value;
    }
  } else if (method === 'invert-medium') {
    // Method 2: Invert with medium threshold
    for (let i = 0; i < data.length; i += 4) {
      const gray = data[i] * 0.299 + data[i+1] * 0.587 + data[i+2] * 0.114;
      const value = gray < 120 ? 255 : 0;
      data[i] = data[i+1] = data[i+2] = value;
    }
  } else if (method === 'normal') {
    // Method 3: Normal threshold (don't invert)
    for (let i = 0; i < data.length; i += 4) {
      const gray = data[i] * 0.299 + data[i+1] * 0.587 + data[i+2] * 0.114;
      const value = gray > 120 ? 255 : 0;
      data[i] = data[i+1] = data[i+2] = value;
    }
  }
  
  ctx.putImageData(imageData, 0, 0);
  return canvas;
}

async function tryOCR(canvas, method) {
  const worker = await Tesseract.createWorker('eng');
  
  await worker.setParameters({
    tessedit_char_whitelist: '0123456789',
    tessedit_pageseg_mode: Tesseract.PSM.AUTO
  });
  
  const { data: { text } } = await worker.recognize(canvas);
  await worker.terminate();
  
  const numbers = text.match(/\d+/g) || [];
  return { method, text, numbers };
}

document.getElementById('photo').addEventListener('change', async function(e) {
  const file = e.target.files[0];
  if (!file) return;

  const loadingEl = document.getElementById('loading');
  const progressEl = document.getElementById('progress');
  const resultEl = document.getElementById('result');
  const debugEl = document.getElementById('debug');
  const previewsEl = document.getElementById('previews');
  
  loadingEl.style.display = 'block';
  progressEl.style.display = 'block';
  resultEl.style.display = 'none';
  debugEl.style.display = 'block';
  previewsEl.style.display = 'block';
  debugEl.textContent = 'Loading image...';

  try {
    // Load image
    const img = new Image();
    await new Promise((resolve, reject) => {
      img.onload = resolve;
      img.onerror = reject;
      img.src = URL.createObjectURL(file);
    });

    debugEl.textContent = `Image: ${img.width}x${img.height}\n\nTrying multiple preprocessing methods...\n`;

    // Try 3 different preprocessing methods
    const methods = ['invert-dark', 'invert-medium', 'normal'];
    const results = [];
    
    for (let i = 0; i < methods.length; i++) {
      const method = methods[i];
      progressEl.textContent = `Testing method ${i+1}/3: ${method}...`;
      
      const canvas = preprocessImage(img, method);
      
      // Show preview
      const previewCanvas = document.getElementById(`preview${i+1}`);
      previewCanvas.width = canvas.width;
      previewCanvas.height = canvas.height;
      const previewCtx = previewCanvas.getContext('2d');
      previewCtx.drawImage(canvas, 0, 0);
      
      // Try OCR
      const result = await tryOCR(canvas, method);
      results.push(result);
      
      debugEl.textContent += `\n${method}:\n  Text: "${result.text.substring(0, 100)}"\n  Numbers: [${result.numbers.join(', ')}]`;
    }
    
    // Find best result (most numbers found, ideally 3+)
    results.sort((a, b) => b.numbers.length - a.numbers.length);
    const best = results[0];
    
    debugEl.textContent += `\n\n✓ Best method: ${best.method} with ${best.numbers.length} numbers`;
    
    if (best.numbers.length >= 3) {
      document.getElementById('sys').textContent = best.numbers[0];
      document.getElementById('dia').textContent = best.numbers[1];
      document.getElementById('pul').textContent = best.numbers[2];
    } else if (best.numbers.length > 0) {
      document.getElementById('sys').textContent = best.numbers[0] || '---';
      document.getElementById('dia').textContent = best.numbers[1] || '---';
      document.getElementById('pul').textContent = best.numbers[2] || '---';
      debugEl.textContent += '\n\n⚠️ Found fewer than 3 numbers';
    } else {
      document.getElementById('sys').textContent = '---';
      document.getElementById('dia').textContent = '---';
      document.getElementById('pul').textContent = '---';
      debugEl.textContent += '\n\n❌ No numbers detected in any method';
    }

    loadingEl.style.display = 'none';
    progressEl.style.display = 'none';
    resultEl.style.display = 'block';

  } catch (error) {
    console.error('OCR Error:', error);
    loadingEl.textContent = 'Error reading image. Please try again.';
    progressEl.style.display = 'none';
    debugEl.textContent += `\n\n❌ Error: ${error.message}`;
  }
});
</script>

</body>
</html>
